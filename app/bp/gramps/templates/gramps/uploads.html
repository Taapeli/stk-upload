{# _gramps/uploads.html_ #}
{#
   Note different versions (sorry):
     	./gramps/templates/gramps/uploads.html
     	./audit/templates/audit/batches.html
		./admin/templates/admin/uploads.html
#}
{% extends "start/s_layout.html" %}
{% block title %}{{ _('Manage Materials') }}{% endblock %}
{% block body %}
{{ super() }}

{% from "start/s_macros.html" import hamburger_menu, state_info with context %}

<style>
h2 { margin-bottom: 0; }
td { position: relative; }
.selected-material { background: bisque; }

div#upload_xml {
    border: solid 1.5pt silver;
    background-color: seashell;
    padding: .5em;
    margin: 0 1em 1em .1em;
    width: fit-content;
}
div#upload_xml div {display: inline;}
form div {margin:.25em;}

td.progress-td { padding: 0; }
.progress {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	z-index: -1;
}
.visible { display: inline; }
.hidden { display:none; }

.op_buttons {
  display: flex;
}
.op_buttons form input {
    float: left;
    margin: 2pt;
}
.submitLink {
  text-decoration: none;
  color: blue;
  cursor: pointer;
  border: gray solid 1pt;
  border-radius: 6pt;
  background: antiquewhite;
  padding: 2pt;
}
.submitLink:hover {
  background: burlywood;
}
</style>

<script>
//TODO: Translation for message
var TOOLARGE =  "The file is too large (max 60 MB)";

function checkFileSize() {
	try {
	 	var input = document.getElementById('filenm');
	 	var file = input.files[0];
	 	if (file.size > 60000000) {
			alert(TOOLARGE);
			return false;
	 	}
	}
	catch {
	}
	return true;
}

// Progress bar
var PROGRESS_INTERVAL = {{interval}}; <!-- 10000; -->

function update_progress(batch_id) {
	// see http://jsfiddle.net/kedctfmj/3/
	$.get("get_progress/" + encodeURIComponent(batch_id), (rsp) => {
		var progress_div = $("td div.progress[data-name='"+batch_id+"']");
		var batch_id_column = progress_div.parent();
		batch_id_column.css("background","oldlace");
        batch_id_column.css("border-color", "#00800070")
        batch_id_column.css("border-width", "3pt")

        progress_div.css("position", "relative");
        progress_div.css("top", "calc(100% - .5em)");
        progress_div.css("height", ".5em");
		progress_div.css("background","Green");
		progress_div.css("opacity","0.5");
		progress_div.css("z-index","1");
		if (rsp.progress == 0) rsp.progress = 1;
		progress_div.get(0).style.width = rsp.progress + "%";
        if (rsp.status == "Loading") 
            setTimeout(function() {update_progress(batch_id)}, PROGRESS_INTERVAL);
		else 
			location.reload();
	});
}

function confirm_delete(subj, name) {
	if (subj == 'xml') {
		var msg = "{{ _('File') }}: " + name + "\n\n" + 
		  "{{ _('Are you sure you want to delete the XML file?') }}";
	} else {
	    var msg = "{{ _('Batch') }}: " + name + "\n\n" + 
	      "{{ _('Are you sure you want to delete this batch from database?') }}";
	}
    var ok = confirm(msg);
    if (!ok) {
        return false;
    }
    return true;
}

function filenm_changed(input) {
    document.forms[0].submit.disabled = !input.value;    
}
</script>

<script src="/static/js/hyperscript.org@0.8.1.js"></script>

{{ hamburger_menu( (
   ) ) }}

<div id="startdiv">
    <div>
		<h1>{{ _('Manage Materials') }}</h1>

{% include "flash_messages.html" %}

{% if current_user.is_authenticated and current_user.has_role('research') %}
        <div id="upload_xml">
            <form action="/gramps/upload" method="post" enctype="multipart/form-data">
                <div><b>{{ _("Send a new Gramps file") }}</b>
                </div>
                <div>
                    <input type="hidden" name="material" value="xml_file">
                    <input type="file" name="filenm" accept=".gramps,.gpkg" onchange="filenm_changed(this)"/>
                </div>
                <div class="submit"> 
                    <input type="submit" name="submit" value="{{ _('Send to database') }}" onclick="checkFileSize()" disabled/>
                </div>
                <div style="display:block; padding:.3em 0;">
                    {{ _('Select Gramps XML File (*.gramps etc) for converting to your candidate material') }}.
                </div>
            </form>
        </div>
{% endif %}

{% if uploads %}
	<table class="fileselect">
       	<tr> 
               <th>{{ _("Batch") }}</th>
               <th>{{ _("Gramps file") }}</th>
               <th>{{ _("Person count") }}</th>
               <th>{{ _("Status") }} {{ state_info() }} </th>
  		</tr>

  {% for upload in uploads %}
        <tr
          {% if active_batch == upload.batch_id %}class="selected-material"{% endif %}
        >
            <td id='{{upload.batch_id}}' class="progress-td">
                <div class="op_buttons">
                    <form method="GET" action="/scene/material/batch">
                        <input type="hidden" name="state" value="Candidate">
                        <input type="hidden" name="batch_id" value="{{upload.batch_id}}">
                        <input type="submit" value="{{upload.batch_id}}"
                            title="{{ _('Browse this material') }}">
                    </form>
                    <form method="GET" action="/gramps/details/{{upload.batch_id}}">
                        <input type="submit" value="info"
                            title="{{ _('Details and operations') }}" class="submitLink">
                    </form>
                </div>

                <div class="progress" data-name='{{upload.batch_id}}'></div>
    {% if upload.state == 'Loading' %}
                     <script>
                         update_progress('{{upload.batch_id}}');
                     </script>
    {% endif -%}
            </td>

            <td>{{upload.xmlname}}

    {% if upload.material_type or upload.description %}
                <br><span class="typedesc">{{upload.material_type|transl('material')}}</span>
    {% endif -%}
    {% if upload.description %} 
                <i>{{ upload.description[0:19] }}
        {% if upload.description|length > 19  %}
                    ... 
                    <div class="tooltip"> 
                    &nbsp;&#8505;&nbsp;
                      <div class="tooltiptext">
                        {{ upload.description }} 
                      </div>
                    </div> 
        {% endif %}
                </i>
    {% endif %}

            </td>

            <td class="center">{% if upload.count %}{{upload.count}}{% endif %}
            </td>
            <td>{{upload.loc_state}}
    {% if upload.auditors %}
                    <br><i>{{ _("Auditor") }}:
        {% for auditor, ts_from, ts_to in upload.auditors %}
                {% if not loop.first %}<br>{% endif %}
                    <span title="{{ _('Auditing time') }}">
                       {{auditor}}&nbsp;{{ts_from|format_ts_day}} â€“ {{ts_to|format_ts_day}}</span>
        {% endfor %}</i>
    {% endif %}
            </td>
        </tr>
  {% endfor %}
   	</table>
{% endif %}
   
  </div>
    <p>&rtrif; <a href="/">{{ _("Back") }}</a></p>

<!-- Startdiv ends -->
</div>

{% endblock %}
<script>
// Status help text
var e = document.getElementById('help');
e.onmouseover = function() {
  document.getElementById('help_box').style.display = 'block';
}
e.onmouseout = function() {
  document.getElementById('help_box').style.display = 'none';
}
</script>
</body>
</html>

