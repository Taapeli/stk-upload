{# _gramps/uploads.html_ #}
{#
   Note different versions (sorry):
     	./gramps/templates/gramps/uploads.html
     	./audit/templates/audit/batches.html
		./admin/templates/admin/uploads.html
#}
{% extends "start/s_layout.html" %}
{% block title %}{{ _('My Candidate Materials') }}{% endblock %}
{% block body %}
{{ super() }}

{% from "start/s_macros.html" import hamburger_menu, state_info with context %}

<style>
h2 {margin-bottom: 0;}
td {
    position: relative;
}
#upload_xml div {display: inline;}
form div {margin:.25em;}
.progress {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	z-index: -1;
}
li > button {
  background: none!important;
  border: none;
  padding: 0!important;
  /*optional*/
  font-family: verdana, sans-serif;
  /*color: #069;*/
  cursor: pointer;
}
li > button:hover, .a:hover, .a1:hover {
  text-decoration: underline;
}
li > button, a, a1 {
  text-decoration: none;
  color: #0306c1;
}
.visible { display: inline; }
.hidden { display:none; }
</style>

<script>
//TODO: Translation for message
var TOOLARGE =  "The file is too large (max 60 MB)";

function checkFileSize() {
	try {
	 	var input = document.getElementById('filenm');
	 	var file = input.files[0];
	 	if (file.size > 60000000) {
			alert(TOOLARGE);
			return false;
	 	}
	}
	catch {
	}
	return true;
}

// Progress bar
var PROGRESS_INTERVAL = {{interval}}; <!-- 10000; -->

function update_progress(batch_id) {
	// see http://jsfiddle.net/kedctfmj/3/
	$.get("get_progress/" + encodeURIComponent(batch_id), (rsp) => {
		var progress_div = $("td div.progress[data-name='"+batch_id+"']");
		var batch_id_column = progress_div.parent(); /*.prev().prev(); */
		batch_id_column.css("background","silver");
		progress_div.css("background","Green");
		progress_div.css("opacity","0.5");
		progress_div.css("z-index","1");
		progress_div.css("margin","4px");
		progress_div.css("border-radius","6px 0 0 6px");
		if (rsp.progress == 0) rsp.progress = 1;
		progress_div.get(0).style.width = rsp.progress + "%";
		if (rsp.status == "Loading") 
			setTimeout(function() {update_progress(batch_id)}, PROGRESS_INTERVAL);
		else 
			location.reload();
	});
}

function confirm_delete(subj, name) {
	if (subj == 'xml') {
		var msg = "{{ _('File') }}: " + name + "\n\n" + 
		  "{{ _('Are you sure you want to delete the XML file?') }}";
	} else {
	    var msg = "{{ _('Batch') }}: " + name + "\n\n" + 
	      "{{ _('Are you sure you want to delete this batch from database?') }}";
	}
    var ok = confirm(msg);
    if (!ok) {
        return false;
    }
    return true;
}
</script>

<script src="/static/js/hyperscript.org@0.8.1.js"></script>

{{ hamburger_menu( (
   ) ) }}

<div id="startdiv">
    <div>
		<h1>{{ _('My Candidate Materials') }}</h1>

{% include "flash_messages.html" %}

	<table class="fileselect">
	{% if uploads %}
        	<tr> 
                <th>{{ _("Batch operations") }}</th>
                <th>{{ _("Gramps file") }}</th>
                <th>{{ _("Person count") }}</th>
                <th>{{ _("Status") }} {{ state_info() }} </th>
   			</tr>
	{% endif %}
 
	{% for upload in uploads %}
        <tr> 
            <td id='{{upload.batch_id}}'>
            	<a href="#" id="a-{{loop.index}}" class="a"
            		hx-get="commands/{{upload.batch_id}}" hx-target="#commands-{{loop.index}}" 
            		_="on click hide .b 
                		then show #b-{{loop.index}} 
                		then show .a 
                		then hide me">
            		▸ {{upload.batch_id}}
            	</a>
            	<span class="b hidden" id="b-{{loop.index}}">
                	▾ <a href="#" class="a1" _="on click hide .b then show .a">
                		{{upload.batch_id}}
                	</a>
            		<div class="cmd" id="commands-{{loop.index}}"></div>
				</span>
				
                <div class="progress" data-name='{{upload.batch_id}}'></div>
				{% if upload.state == 'Loading' %}
                     <script>
                         setTimeout( function() {update_progress('{{upload.batch_id}}')}, 1000 );
                     </script>
				{% endif %}
            </td>

            <td>{{upload.xmlname}}

		{% if upload.material_type or upload.description %}
                <br><span class="typedesc">{{upload.material_type|transl('material')}}</span>
		{% endif %}
		{% if upload.description %} 
                <i>{{ upload.description[0:19] }}
			{% if upload.description|length > 19  %}
                    ... 
                    <div class="tooltip"> 
                    &nbsp;&#8505;&nbsp;
                      <div class="tooltiptext">
                        {{ upload.description }} 
                      </div>
                    </div> 
			{% endif %}
                </i>
		{% endif %}

            </td>

            <td class="center">{% if upload.count %}{{upload.count}}{% endif %}
            </td>
            <td>{{upload.status}}
			{% if upload.auditors %}
                    <br><i>{{ _("Auditor") }}:
            	{% for auditor, ts, ts_str in upload.auditors %}
            			<span title="{{ _('Audit start date') }}">{{auditor}}&nbsp;{{ts_str}}</span>
            	{% endfor %}</i>
			{% endif %}
            </td>
        </tr>
	{% endfor %}

{% if current_user.is_authenticated and current_user.has_role('research') %}
		<form action="/gramps/upload" method="post" enctype="multipart/form-data">
   			<tr id="upload_xml" title="{{ _('Select Gramps XML File (*.gramps etc) for converting to your candidate material') }}.">
   				<td><b>{{ _("Send a new Gramps file") }}</b>
   				</td>
   				<td colspan="4">
   					<div>
	   					<div>
				        	<input type="hidden" name="material" value="xml_file">
				        	<input type="file" name="filenm" accept=".gramps,.gpkg"/>
				        </div>
				        <div class="submit"> 
				        	<input type="submit" value="{{ _('Send to database') }}" onclick="checkFileSize()"/>
				        </div>
   					</div>
   				</td>
   			</tr>
 		</form>
   </div>
   	</table>
   
  </div>
{% endif %}

<!-- Startdiv ends -->
</div>
{% endblock %}
<script>
// Status help text
var e = document.getElementById('help');
e.onmouseover = function() {
  document.getElementById('help_box').style.display = 'block';
}
e.onmouseout = function() {
  document.getElementById('help_box').style.display = 'none';
}
</script>
</body>
</html>

