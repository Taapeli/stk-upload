{# _templates/scene/person.html_ #}
{% extends "/scene/layout.html" %}
{% import '/scene/macros.html' as macro with context %}
{% block title %}{{ macro.person_name_plain(person.names[0]) }}{% endblock %}
{% block body %}
{{ super() }}
<style>
u { color: DarkKhaki; text-decoration: none; }
#citTest { margin:1em; }
#citTest div { display: inline-block; }
#citTbl  td { border: 2px solid brown; }
</style>
<!-- <script>
// var cits = ["rivi1", "rivi2"];

{% set glob = namespace(cits=[]) %} {# members [mark, source, cit] #}

{% macro citdump() -%}
    <table style="border: 2px solid brown;">
        <tr><th>mark</th><th>source</th><th>cita</th></tr>
    {% for c in glob.cits %}
        <tr><td>"{{c[0]}}"</td><td>{{c[1]}}</td><td>{{c[2]}}</td></tr>
    {% endfor %}
    </table>
{%- endmacro %}

{%- macro citmark(cit) -%}
    {#  Finds or creates the mark symbol for given citation.
    
        The mark symbol "1a" is formatted by counting different
        loc.source, loc.cita values found in global citations table glob.cits
        before current citation (cit.uniq_id, cit.source_ref).
     #}
    {% set loc = namespace(found=false,source=0,cita=0) %}

	{% for mark, source, cita in glob.cits if not loc.found %}
	   {% if source == cit.source_id %}<!-- {{source}} == {{cit.source_id}} -->
	       {% if cita == cit.uniq_id %}<!-- cita {{cita}} != {{cit.uniq_id}} -->
               {# A known source/citation combination #}
	           {{mark}}
	           {% set loc.found = true %}
	       {% else %}<!-- cita {{cita}} != {{cit.uniq_id}} -->
	           {% set loc.cita = loc.cita + 1 %}
	       {% endif %}
       {% else %}<!-- {{source}} != {{cit.source_id}} -->
           {% set loc.source = loc.source + 1 %}
	   {% endif %}
	{% endfor %}

    {% if not loc.found %}
		{# This source/citation is not in global citations table #}
		{% set mark = (loc.source + 1) ~ "abcderfghijklmopqrstuvwxyzåäö"[loc.cita] %}
		{% set glob.cits = glob.cits + [[mark|trim, cit.source_id, cit.uniq_id]] %}
	    {{ mark }}
	{% endif %}
{%- endmacro %}


<div id="startdiv">
    <h2>{{ _("Person's details") }}</h2>
</div>

{{ macro.menu(menuno) }}
    <div class="content" id="IndividualDetail">

        {% if person.media_ref %}<div class="snapshot">
            <div class="thumbnail">
                <div><a href="#indivgallery">{% set photo = obj[person.media_ref[0]] %}
	                <img alt="({{ _('Photo') }})" 
	                     src="/scene/thumbnail?id={{photo.uuid}}" 
	                     title="key = {{photo.uuid_str()}}"/>
                </a></div>
                <p style="margin:0;">{{photo.description}}</p>
            </div>
        </div>{% endif %}

        <h3 style="position:sticky; top:0;" title="{{ _('Top') }}"><a href="#">{{person.names[0].firstname}} 
            <i>{{person.names[0].suffix}}</i> {{person.names[0].prefix}} <b>{{person.names[0].surname}}</b></a>
            {{macro.citation_link(person.citation_ref, obj)}}
        </h3>

        {% set myid = person.uniq_id %}
        
        <div id="summaryarea">
            <table>
                <tr>
                    <td class="ColumnAttribute" style="padding-bottom: .5em;">{{ _("Identifiers") }}</td>
                    <td class="ColumnValue">
                        {{macro.all_obj_ids(person)}} /
                        <span class="id" title='{{ _("Sorting key") }}'>{{person.sortname}}</span>
                        <span style="font-size:70%;background:lightgray;">&nbsp;
                            <a href="/scene/person={{person.uniq_id}}">v1</a> /
                            <a href="/scene/person/{{person.uniq_id}}">v2</a> /
                            <a href="/scene/person?uuid={{person.uuid}}">v3</a> &nbsp;
                        </span>
                    </td>
                </tr>

                {% for pname in person.names|sort(attribute='order') %}<tr>
                    <td class="ColumnAttribute">{{pname.order + 1}}. {{pname.type|transl('nt')}}</td>
                    <td class="ColumnValue">
                        <span title="{{ _('first name') }}">{{pname.firstname}}</span>
                        <i title="{{ _('patronymic') }}">{{pname.suffix}}</i>
                        {% if pname.prefix %}<span title="etuliite">{{pname.prefix}}</span>{% endif %}
                        <b title="{{ _('surname') }}">{{pname.surname}}</b>

	                    {{macro.citation_link(pname.citation_ref, obj)}}
                    </td>
                </tr>{% endfor %}
                   
                {% if person.sex %}<tr>
                    <td class="ColumnAttribute">{{ _("Gender") }}</td>
                    <td class="ColumnValue">{{ person.sex_symbol() }} {{ person.sex_str() }}</td>
                </tr>{% endif %}
                {% if person.priv %}<tr>
                    <td class="ColumnValue" title="{{ _('Private data') }}">{{ macro.lock(person.priv) }}</td>
                </tr>{% endif %}
                
                {% if person.confidence > '' %}<tr>
                    <td class="ColumnAttribute">{{ _("Confidence of data") }}</td>
                    <td class="ColumnValue">{{ macro.stars(person.confidence|float) }}</td>
                </tr>{% endif %}
<!--            <tr>
                    <td class="ColumnAttribute">{{ _("Age at death") }}</td>
                    <td class="ColumnValue">66 vuotta 10 kuukautta 21 päivää</td>
                </tr>
-->
{% if person.note_ref %}
                <tr><td></td>
                    <td>► <a href="#notes" class="inlink">{{ _('See') }}
                    {{ _('Person Notes') }}</a></td>
                </tr>
{% endif %}
            </table>
        </div>

        <div class="subsection" id="events">
            <h4>{{ _("Events") }}</h4>
            <table class="infolist eventlist">
                <thead>
                    <tr>
                        <th class="ColumnEvent">{{ _("Event") }}</th>
                        <th class="ColumnDate">{{ _("Date") }}</th>
                        <th class="ColumnPlace">{{ _("Place") }}</th>
                        <th class="ColumnDescription">{{ _("Description and Notes") }}</th>
                    </tr>
                </thead>
                <tbody>
{% for e in person.events if e.type != "Cause Of Death" %}
                    <tr>
{#  person.events[0].citation_ref[0] = 90323
    objs[person.events[0].citation_ref[0]] = <models.gen.citation.Citation object at 0x7f0a24696ac8> = cr
    objs[person.events[0].citation_ref[0]].mark = '1a'
#}
                        <td class="ColumnEvent" title="{{e.id}} {{e.uuid_short()}} nr:{{e.uniq_id}}">
                            <div class="magnifier" alt="{{e.uniq_id}}">
    {% if e.type == "Baptism" %}    <a href="/scene/event/{{e.uniq_id}}" class="inlink">&rarr;&nbsp;
                                    {{e.type|transl('evt')}}
                                </a>
    {% else %}                      {{e.type|transl('evt')}}
    {% endif %}
    {% if e.role and e.role != "Primary" %}
                                <span class="typedesc">({{e.role|transl('role')}})</span>
    {% endif %}
                                {{macro.citation_link(e.citation_ref, obj)}}
                            </div>
                        </td>

                        <td class="ColumnDate">{{e.dates}}</td>

                        <td class="ColumnPlace">{% set br=0 %}{% for pref in e.place_ref %}
                            {% if br == 0 %}{% set br = 1 %}{% else %}/{% endif %}
                            <a href="/scene/location/uuid={{obj[pref].uuid}}" class="inlink"
                             title="{{ _('of type') }} {{obj[pref].type}}; {{ _('see details of place') }}">
                            {{macro.place_names_lang(obj[pref])}}</a>{% if obj[pref].uppers 
                              %}, <small>{{macro.place_names_lang(obj[pref].uppers[0])}}</small>{% endif %}
                            {% endfor %}
                        </td>

                        <td class="ColumnDescription"><div>{{e.description}}</div>
                            <div>{% if e.type == "Death" and person.cause_of_death %}<span 
                                    class="typedesc">{{ "Cause Of Death"|transl('notet') }}</span>
                                        {% if person.cause_of_death.dates %}{{person.cause_of_death.dates}}{% endif %}
                                        {{person.cause_of_death.description}}
                                        {{macro.place_names_lang(person.cause_of_death)}}<br>
                            	{% endif %}
                            {% if e.note_ref %}
                            	{% for ref in e.note_ref %}{% set note = obj[ref] %}
	                            	<div><span class="typedesc">{{ note.type|transl('notet') }}</span>
				                      {{macro.citation_link(note.citation_ref, obj)}}
	                            	  {{ macro.notelink(note) }}</div>
	                            {% endfor %}
                           	{% endif %}
                            {% if e.place_ref %}
                                {% for pref in e.place_ref %}
                                    {% for ref in obj[pref].note_ref %}
                               <div><span class="typedesc">{{ obj[ref].type|transl('notet') }}</span>
                                    {{ macro.notelink(obj[ref]) }}</div>{% endfor %}
                                {% endfor %}
                            {% endif %}
                            </div>
                        </td>
{#                  {% endif %}
#}
                    </tr>
{% endfor %}
                 </tbody>
            </table>
{{ citdump() }}
        </div>

{% if true %}
        <div class="subsection" id="notes">
            <h4>Js-testaus</h4>
            <div id="citTest">
<!--                <div><button type="button" onclick="tbl.findCitations('demo', 'citTbl')">Try it</button></div> -->
               <div><table id="citTbl"><body><tr><td>Tähän vastaus</td></tr></body></table></div>
               <div id="demo"><p>Sisällöt</p></div>
            </div>
        </div>
{% endif %}


        <div class="subsection" id="families">
            <h4>{{ _("Families") }}</h4>
{% set myid = person.uuid %}
{% if person.families_as_child %}
            <div class="mainbox" title="{{ _('Families') }}">
                <p>{{ _("Parents' family") }}</p>
            {% for fam in person.families_as_child %}{% if fam.role == "CHILD" %}
                <div class="groupbox">
	                <div class="familybox" title="{{ _('family') }} {{fam.id}}">
                        <p><a href="/scene/family?uuid={{fam.uuid}}" title="{{fam.uuid}}" class="inlink">
                             {{ _("Family") }} {{fam.rel_type|transl('marr')|lower}}</a>
                           {{fam.marriage_dates}}</p>
	                    <ul>{% if fam.father %}
	                        <li>{{ _("Man") }}: {{ macro.person(fam.father, myid) }}</li>
	                {% endif %}{% if fam.mother %}
	                        <li>{{ _("Wife") }}: {{ macro.person(fam.mother, myid) }}</li>
	                {% endif %}{% if fam.children %}
	                        <li>{{ _("Children") }}<ul>{% for ch in fam.children|sort %}
	                            <li>{{ch.child_by_sex()}}: {{ macro.person(ch, myid) }}</li>{% endfor %}
	                        </ul></li>
	                {% endif %}
	                    </ul>
	                </div>
                </div>
            </div>
            {% endif %}{% endfor %}
{% endif %}

            <div class="mainbox" title="{{ _('Central person') }}">
	            <p>{{person.names[0].firstname}} {{ _("self") }}</p>
	            <div class="groupbox">
		            <div class="personbox" title="{{ _('Self') }}">
		                <span title="{{ _('first name') }}">{{person.names[0].firstname}}</span>
		                {% if not person.names[0].surname %}<i title="{{ _('patronymic') }}">{{person.names[0].suffix}}</i>
		                {% else %}<b title="{{ _('surname') }}">{{person.names[0].prefix}} {{person.names[0].surname}}</b>
		                {% endif %}
		            </div>
	            </div>
	        </div>

{% if person.families_as_parent %}
            <div class="mainbox" title="{{ _('Own families') }}">
                <p>{{ _("As Parent in Family") }}</p>
	            <div class="groupbox">
		            {% for fam in person.families_as_parent %}{% if fam.role != "CHILD" %}
		            <div class="familybox" title="perhe {{fam.id}} {{fam.role}}">
		                <p><a href="/scene/family?uuid={{fam.uuid}}" title="{{fam.uuid}}" class="inlink">
                             {{ _("Family") }} {{fam.rel_type|transl('marr')|lower}}</a>
                           {{fam.marriage_dates}}</p>
		                <ul>{% if fam.father %}
		                        <li>{{ _("Father") }}: {{ macro.person(fam.father, myid) }}</li>
		                {% endif %}{% if fam.mother %}
		                        <li>{{ _("Mother") }}: {{ macro.person(fam.mother, myid) }}</li>
		                {% endif %}{% if fam.children|count %}
		                        <li>{{ _("Children") }}<ul>{% for ch in fam.children|sort %}
		                            <li>{{ch.child_by_sex()}}: {{ macro.person(ch, myid) }}</li>
		                         {% endfor %}</ul></li>
		                {% endif %}
		                    </ul>
		                </ol></div>
		            {% endif %}{% endfor %}
	             </div>
             </div>
{% endif %}
        </div>

{% if person.media_ref %}
        <div class="subsection" id="indivgallery">
            <h4>{{ _("Media files") }}</h4>
        {% for ref in person.media_ref %}
            <div class="thumbnail">{% set photo=obj[ref] %}
                <a href="/scene/media/{{photo.name}}?id={{photo.uuid}}">
	                <img alt="({{ _('Photo') }})" 
	                     src="/scene/thumbnail?id={{photo.uuid}}" 
	                     title="key = {{photo.uuid_str()}}"/>
                </a>
                <p>{{photo.description}}</p>
            </div>
        {% endfor %}
            <div class="fullclear"></div>
        </div>
{% endif %}

{% if person.note_ref %}
        <div class="subsection" id="notes">
            <h4>{{ _("Person Notes") }}</h4>
    {% for ref in person.note_ref %}{% set note = obj[ref] %}
            <div class="grampsstylednote">
                 <p>► <span class="typedesc">{{ note.type|transl('notet') }}</span>
                    {{macro.citation_link(note.citation_ref, obj)}}
                    {{ macro.notelink(note) }}</p>
            </div>
    {% endfor %}
        </div>
{% endif %}

        <div class="subsection" id="sourcerefs">
            <h4>{{ _("Source references") }}</h4>
            <div id="sourcerefContent"></div>
{#
		    cita = citations[0]               = <models.gen.citation.Citation object at 0x7f1374e1a6a0>
            cita.mark                         = '1a'
		    cita.page                         = 'Wiala'
		    source = obj[cita.source_id]      = <models.gen.source.Source object at 0x7f1374e1a978>
            source.stitle                     = 'Akaa rippikirja 1774-1779'
            cita.medium                       = 'Book'
		    source.repositories[0]            = <models.gen.repository.Repository object at 0x7f1374e1ae48>
		    source.repositories[0].rname      = 'Akaan seurakunnan arkisto'
<ul>
#}

{% for clist in citations | groupby('mark_sorter') %}
    <div class="sourceDesc"><!-- Source {{ clist.grouper }} -->
        {% set c = clist.list[0] %}
        {% if c.source_id %}{% set source = obj[c.source_id] %}
                   <a href="/scene/source={{source.uniq_id}}" class="inlink"
                      title="[{{c.id}}] {{ _('See source %(name)s details', name=source.id) }}">
                      {{source.stitle}}</a>
	            <!-- Repository -->
	            {% if source.repositories %} –
	               <span class="typedesc">{{ c.source_medium|transl('medium') }}</span>
	               <i>{{obj[source.repositories[0]].rname}}</i>
                   {% if source.repositories|length > 1 %}<b> JA MUITA ARKISTOJA</b>{% endif %}
	            {% else %}  <b title="{{source}}">{{ _("No archive information!") }}</b>
	            {% endif %}
        {% else %}<b title="{{c}}">{{ _("No source information!") }}</b>
        {% endif %}
        <!-- Citation -->
        {% for cita in clist.list %}
             {% set conf = cita.confidence | int %}
             <div class="citaDesc" id="sref{{ cita.mark|trim }}"
                {% if cita.confidence and cita.confidence < "2" %}style="color:red"{% endif %}>
                  <span title="[{{cita.id}} nr:{{cita.uniq_id}}] {{cita.confidence|transl("conf")}} {{ _('confidence') }} ({{cita.confidence}})">
                      <b>{{ cita.mark }}</b> {{ _("Page") }}: {{cita.page}} &nbsp; {{ macro.stars(conf) }}
                  </span> {{ cita.noteref }}
                {% for nref in cita.note_ref %} &nbsp;►&nbsp;{{ macro.notelink(obj[nref]) }}
                {% endfor %}
             </div>
        {% endfor %}
   </div>
{% endfor %}

        </div>
    </div>
<script>
var tbl = new citTable();
tbl.findCitations('demo');
tbl.listCitations('citTbl');
tbl.sourceReferences('sourcerefContent');
</script>
{% endblock %}

