{# _myapp/templates/list_persons.html_ #}
{% extends "/scene/layout.html" %}
{% block title %}{{ _('List of persons') }}{% endblock %}
{% block body %}
{{ super() }}
{% import '/scene/macros.html' as macro with context %}

{% set cnt = persons|count %}
{% set user = owner_filter.user %}
{% set next = owner_filter.scope %}
{% set filt_owners = owner_filter.filter %}
{% if filt_owners == 3 or filt_owners == 5 %}{#
	#   common_own   011 3 = 1+2 = users data & Isotammi
	#   common_batch 101 5 = 1+4 = user batch & Isotammi #}
	{% set multi_owners = filt_owners - 1 %}
    {% set my_set = owner_filter.choices.as_str[filt_owners-1] %}
    {% set my_common = "Isotammi" %}
{% else %}
    {% set multi_owners = 0 %}
    {% set my_set = owner_filter.choices.as_str[filt_owners] %}
{% endif %}
<style>
.grid {  display: flex; }
.grid .col { float: left; }
.grid .col.col_event {
    width: 9em;
    font-style: italic;
    color: #000066;
}
.grid .col.col_desc { width: 60%; }
.major { font-weight: bold; }
</style>

<div id="startdiv">
	{% if session['owner_filter'] %}
	    <h2>{{ _('Persons filtered by') }} {{ owner_filter.owner_str() }}</h2>
	{# elif rule[0] == 'refname' %}
	    <h2>{{ _('Persons carrying a Name') }} {{ rule[1] }}</h2> #}
	{% else %}
	    <h2>{{ _('Persons') }}</h2>
	{% endif %}
	
<!-- 	<p><small>{{cnt}} persons, user {{user}}, filter {{filt_owners}} {{my_set}}, next {{next}}</small></p> -->
</div>

{{ macro.menu(menuno) }}
	<div class="content" id="Individuals">
        <div id="summaryarea">
            <div class="flex-container">
	           <div id="description">
                   <p>{{ _('Displaying %(num)s distinct persons', num=cnt) }}
                       {% if next[0] > ' ' %}{{ _('starting <tt>%(name)s</tt>', name=next[0]) }},
                       {% else %}{{ _('from begin') }},
                       {% endif %}{{ _('data set') }}
                       <b>{% if multi_owners %}
                            &FilledSmallSquare;&nbsp;{{my_set}} / <span class="owner">&nbsp;{{my_common}}&nbsp;</span>.
                       {% else %}{{my_set}}
                       {% endif %}</b>
                       {% if user %}
                       (<i><a href="/scene?{{ {'fw':next[0]} | urlencode }}" title="vaihda poimintasääntöä" 
                            style="text-decoration-line: underline;">Vaihda</a></i>).
                       {% endif %}</p>
	           </div>
	           <div>
	               <form action="/scene/persons_all">
	                 <fieldset>
	                    <input type="hidden" name="c" value="50" >
	                    <label for="fw">{{ _('Go to') }}</label>
	                    <input type="text" name="fw" size="8" 
	                     title="{{ _('Starting letters of surname') }}" 
	                     placeholder="{{ _('Surname') }}">
	                    <input type="submit" value=" > ">
	                 </fieldset>
	               </form>
	           </div>
            </div>
	        {% with messages = get_flashed_messages(with_categories=true) %}
	          {% if messages %}
	            <ul  class='flashes'>
	            {% for category, message in messages %}
	              <li class='flash_{{category}}'>{{ message }}</li>
	            {% endfor %}
	            </ul>
	          {% endif %}
	        {% endwith %}
        </div>

    {% if cnt %}
		<div id="alphanav">{% set alpha = "¤" %}
			<ul><li><a href="#" title="{{ _('Top of page') }}">&uarr;</a></li>
			    <li>{% if next[0] > ' ' %}
			         <a href="/scene/persons_all/?fw=%20" title="{{ _('first page') }}" class="navlink">|&lt;</a>
			    {% else %}<span class="navlink">|&lt;</span>
			    {% endif %}</li>
                <li><span class="navlink" title="{{ _('previous page') }}" style="cursor:not-allowed"> &lt; </span></li>

            {% for p in persons %}
                {% set ini = p.sortname[0] %}
                {% if loop.changed(ini) %}{% if not ini == "#" %}
	                <li><a href="javascript:jump('{{ini}}')" title="{{ _('Alphabetical Menu') }}: {{ini}}">{{ini}}</a></li>
                {% endif %}{% endif %}
            {% endfor %}
            {% if next[1].startswith('>') %}
                <li><span class="navlink" title="{{ _('no next page') }}" style="cursor:not-allowed"> &gt; </span></li>
            {% else %}
	            <li><a href="/scene/persons_all/?{{ {'fw':next[1]} | urlencode }}" 
	                 title="{{ _('next page') }}" class="navlink"> &gt; </a></li>
            {% endif %}
            </ul>

		</div>
		<table class="IndividualList">
			<thead>
				<tr><th></th>
					<th>{{ _('Person') }}</th>
                    <th>{{ _("Events") }}</th>
				</tr>
			</thead>
			<tbody>

	    {% for p in persons %}
	       {% if multi_owners %}
               {% set owner_but_me = p.owners | sort %}
	       {% else %}{% set owner_but_me = [] %}
	       {% endif %}
	            <tr><td class="ColumnAlpha">
	               {% set ini = p.sortname[0] %}
	               {% if loop.changed(ini) %}
		               {% if ini == "#" %}{% set symbol = '–' %}
		               {% else %}{% set symbol = ini %}{% endif %}
		               <a id="{{symbol}}" name="{{ini}}" title="{{ _('Back to Top') }}" 
		                  href="#">{{symbol}}</a>
	               {% endif %}</td>

	                <td class="ColumnPerson"><div>
	                   {% for ow in p.owners %}
                           {% if ow == user %}&FilledSmallSquare;
                           {% else %}<span class="owner">&nbsp;{{ow}}&nbsp;</span>{% endif %}
	                   {% endfor %}
	                   {% if p.uuid %}
		                   <a href="/scene/person/uuid={{p.uuid}}"
		                     title="{{ _('see details of person %(id)s', id=p.uuid[:6]) }}">
		               {% endif %}
		               {{p.names[0].firstname}} 
		               {% if p.names[0].surname %} {% if p.names[0].prefix %}{{p.names[0].prefix}}{% endif %}
		               <b>{{p.names[0].surname}}</b>
		               {% else %}<i>{{p.names[0].suffix}}</i>{% endif %}{% if p.uuid %}</a>{% endif %}

		               {%set eka = 1 %}
		               {% for name in p.names %}
		                  {% if eka == 1 %}{% set eka = 0 %}{% else %}<br><small>
		                      <span class="typedesc">{{name.type|transl('nt')}}</span> 
		                      {{name.firstname}} 
                              {% if name.surname %} {% if name.prefix %}{{name.prefix}}{% endif %}
		                	  <b>{{name.surname}}</b>
                            {% else %}<i>{{name.suffix}}</i>{% endif %}</small>
                          {% endif %}
                       {% endfor %}

                       <br>
                       {% if p.uuid %}
	                       <a href="/scene/person/uuid={{p.uuid}}" class="idno">Id:{{p.uuid[:6]}} /</a>
	                   {% else %} <a href="/scene/person/{{p.uniq_id}}" class="idno">ID: {{p.uniq_id}} /</a>
	                   {% endif %}
                               {# TODO Remove the test link at ']' #}
                       <span class="id" title="{{ _('Original ID') }}">{{p.id}}</span>
<!--                        <span class="refname" title="{{ _('Sorting name') }}">{{p.sortname}}</span> -->
	                </div></td>

                  <td class="ColumnEvent">
            {% if p.events is iterable %}
                <div>{% for e in p.events|sort(attribute='date') %}
                    {% if e.type == "Birth" or e.type == "Death" %}{% set ecl = "major" %}
                    {% else %}{% set ecl = "minor" %}{% endif %}
                      <div class="grid">
                          <div class="col col_event {{ecl}}">{{e.type|transl('evt')|lower}}</div>
                          <div class="col col_desc">{{e.description}}
                          {% if e.dates %}{{e.dates}} {% endif %}
                          {% if e.place %} | {{e.place}}{% endif %}</div>
                      </div>
                {% endfor %}</div>
            {% else %}<u>See person {{p.events}}</u></td>
            {% endif %}
	    {% endfor %}
        {% if next[1].startswith('>') %}
                <tr><td class="ColumnAlpha"></td>
                    <td colspan="2" style="text-align: center;">
                        <i style="background-color:#999; padding:3px 30px 3px 30px; color:white; border-radius:15px;">
                            {{ _('End of data') }}</i>
                    </td>
                </tr>
	    {% endif %}
            </tbody>
        </table>
	{% else %}
        <div class="NotFound">
            <p>{{ _('No one found with search keys starting "%(name)s"', name=next[0]) }}.</p>
            {% if next[0] %}<p>&nbsp;&#9656; <a href="/scene/persons_all/?fw=%20" 
                title="{{ _('first page') }}">{{ _("Go to the first person") }}</a></p>
            {% endif %}
        </div>
        <p>&nbsp;</p>
	{% endif %}
    </div>
{% endblock %}
