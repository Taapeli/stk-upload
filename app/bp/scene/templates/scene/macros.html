# Jinja macros for Scene pages
# 1.4.2020 / JMä


# 0. Common widgets

{% macro lock(value) -%}
    {# Draws a lock icon, is value is '1' #}
	{% if value == '1' %}&#x1F512;{% endif %}                           
{%- endmacro %}

{% macro stars(value) -%}
   {# Confidence value as stars. 
      Alternative method: scene_scripts.js:stars()

      https://www.w3schools.com/charsets/ref_utf_symbols.asp
      - filled BLACK STAR ★   open WHITE STAR ☆ HALF STAR ½
      - WHITE FROWNING FACE &#9785; BLACK FLAG &#9873;
      - SOUTH EAST ARROW TO CORNER &#8690; (outlink)
   #}
   {% if value <= 1 %}
     {% if value == 0 %}&#9873;&#9873;
     {% else %}&#9873;
     {% endif %}
   {% else %}
     {% if   value < 1.25 %}★☆☆☆
     {% elif value < 1.75 %}★½☆☆
     {% elif value < 2.25 %}★★☆☆
     {% elif value < 2.75 %}★★½☆
     {% elif value < 3.25 %}★★★☆
     {% elif value < 3.75 %}★★★½;
     {% endif %}
   {% endif %}                           
{%- endmacro %}


# 1. Page tabs

{% macro menu(value) -%}
  {% if current_user and current_user.is_authenticated %}{% set hide = 0 %}
  {% else %}{% set hide = 1 %}{% endif %}
    <!-- {{hide}} {{value}} -->
    <div class="wrapper" id="nav" role="navigation">
        <div class="container">
            <ul class="menu" id="dropmenu">
                <li{% if value == 0 %} class="CurrentSection"
                  {% endif %}><a {% if hide %}href="#" class="dimmed"{% else %}href="/scene/persons/search"{% endif %}
                   title="{{ _('Search for people') }}">{{ _('Search') }}</a></li>
{#              <li{% if value == 1 %} class="CurrentSection"
                  {% endif %}><a {% if hide %}href="#" class="dimmed"{% else %}href="/scene/persons/all"{% endif %}
                   title="{{ _('All persons') }}">{{ _('Names') }}</a></li>
#}
                <li{% if value == 12 %} class="CurrentSection"
                  {% endif %}><a href="/scene/persons/all"
                   title="{{ _('Person list by default name') }}">{{ _('Persons') }}</a></li>

            {# <li{% if value == 2 %} class="CurrentSection"
                  {% endif %}><a href="#" class="dimmed"
                   title="{{ _('Surnames') }}">{{ _('Names') }}</a></li>
             #}
                <li{% if value == 3 %} class="CurrentSection"
                  {% endif %}><a {% if hide %}href="#" class="dimmed"{% else %} href="/scene/families?o=father&f=%20"{% endif %}
                   title="{{ _('Families') }}">{{ _('Families') }}</a></li>

                <li{% if value == 4 %} class="CurrentSection"
                  {% endif %}><a href="/scene/locations"
                   title="{{ _('Places') }}">{{ _('Places') }}</a></li>

                <li{% if value == 51 %} class="CurrentSection"
                  {% endif %}><a href="/scene/repositories"
                   title="{{ _('Repositories') }}">{{ _('Repositories') }}</a></li>

                <li{% if value == 5 %} class="CurrentSection"
                  {% endif %}><a href="/scene/sources"
                   title="{{ _('Sources') }}">{{ _('Sources') }}</a></li>

                <li{% if value == 6 %} class="CurrentSection"
                  {% endif %}><a href="/scene/medias"
                   title="{{ _('Thumbnails') }}">{{ _('Pictures') }}</a></li>

        {% if current_user.is_authenticated and current_user.username != "guest" %}
                <li{% if value == 7 %} class="CurrentSection"
                  {% endif %}><a href="/scene/details/"
                   title="{{ _('Material details and actions') }}">{{ _('Material details') }}</a></li>
        {% endif %}

        {% if user_context.SHOW_DISCUSSION %}
                <li{% if value == 8 %} class="CurrentSection"
                  {% endif %}><a href="/scene/topics" class="Auditor"
                   title="{{ _('Discussions') }}">{{ _('Discussions') }}</a></li>
        {% endif %}

        {% if not current_user or not current_user.is_authenticated %}
                <li id="loginpage"><a href="/login"
                     title="{{ _('Get more info') }}">{{ _('Log in to Isotammi') }}!</a></li>
        {% endif %}
            </ul>
        </div>
    </div>
{%- endmacro %}

{% macro show_use_case(no_change) -%}
    {#  Show material description. (no_change is obsolete!) #}
    {% if user_context and not config['DEMO'] %}
        {{ user_context.display_current_material() }}
    {% endif %}
{%- endmacro %}

# 1.1 Previous/forward buttons "|<" "<", ">"

{% macro buttons_bw(user_context, base_url) -%}
    {# To first page button "|<" -#}
    {% if user_context.at_start() -%}
                <li><span class="navlink">|&lt;</span></li>
    {% else %}
        {% if '?' in base_url %}{% set cat='&' %}
        {% else %}{% set cat='?' %}{% endif %}
                <li><a href="{{base_url}}{{cat}}fw=%20" title="{{ _('first page') }}"
                       class="navlink">|&lt;</a></li>
    {% endif %} 
    {# To previous page button "<" (to be done later) #}
                <li><span class="navlink" title="{{ _('previous page') }}"
                          style="cursor:not-allowed"> &lt; </span></li>
{%- endmacro %}}

{% macro buttons_fw(user_context, base_url) -%}
    {# To next page button ">" -#}
    {% set next_fw = user_context.next_name('fw') %}
    {% if user_context.at_end() %}
                    <li><span class="navlink" title="{{ _('no next page') }}"
                              style="cursor:not-allowed"> &gt; </span></li>
    {% else %}
        {% if '?' in base_url %}{% set cat='&' %}
        {% else %}{% set cat='?' %}{% endif %}
                    <li><a href="{{base_url}}{{cat}}fw={{next_fw | urlencode }}"
                        title="{{ _('next page starting') }} {{next_fw|replace('#', ' ')}}"
                        class="navlink"> &gt; </a></li>
    {% endif -%}
{%- endmacro %}}

# 2. Data display

{% macro obj_ids(obj, is_common=True) -%}
	{# If is_common, do not show Gramps ID #}
    <span class="isotammi_id" title="Isotammi-ID">{{obj.iid}}</span>
    {% if not is_common %} / <span class="gedcom_id" title="Gramps ID">{{obj.id}}</span>
    {% endif %}
{%- endmacro %}

{% macro all_obj_ids(obj, margin) -%}
    {#  Formats object keys and timestamp for display. Positioned at right margin.
        If 2nd arguments (like "350px") is present, leave the given right margin.
     #}
    <span class="isotammi_id" title="Isotammi-ID">{{obj.iid}}</span> /
    <span class="gedcom_id" title="Gramps ID">{{obj.id}}</span>
    {% if obj.change %}
    <span id="changetime" title="{{ _('latest change time and contributor') }}"
        {%- if margin %}style='margin-right:{{margin}}'{% endif %}
        >{{ _("edited") }} {{obj.change_str()}}
        {%- if user_context.material %} – <span>
            {% if user_context.is_common() %}
                {{ _('origin from') }}: {{obj.root.root_user}}{{ _(', material')}} {{obj.root.batch_id}}
            {% else %}{{ _('User data')|lower }}
            {% endif %}
        </span>
        {% endif %}
    </span>
    {% endif -%}
{%- endmacro %}


{% macro obj_title(obj) -%}{% if obj.root %}
		{#  Formats object keys and root for display. #}
    	{{obj.iid}} / {{obj.id}}{% if user_context.is_common()
    	%}{{ _( ', origin from material batch %(root)s', root=obj.root.batch_id ) }}
    	{% endif %}
    {% else %}{{obj.iid}} / {{obj.id}}{% endif -%}
{%- endmacro %}

{% macro attr_rows(obj, colspan="1") %}
	{# Shows all Gramps attribute data for this object as table rows #} 
	{% if obj.attrs %}
        {% for key, values in obj.attrs.items() %}
            <tr class="attrs" title="{{ _('Attribute') }}: '{{key}}'">
            	<td class="ColumnAttribute">&raquo;{{ _(key) }}</td>
	            <td class="Value" colspan="{{colspan}}">
	            	<ul style="margin:0">{% for value in values %}
	            		<li>&nbsp;{{ value }}</li>
	            	{% endfor %}</ul>
	            </td>
            </tr>
        {% endfor %}
	{% endif %}
{%- endmacro %}


# 2.1 Person

{% macro person_name(name) -%}
    {#  Formats a Person name. Shows firstname and a surname or patronyme. #}
    {{name.firstname}}
    {% if not name.surname %}<i>{{name.suffix}}</i>{% endif %} {{name.prefix}} <b>{{name.surname}}</b>
{%- endmacro %}

{% macro person_name_plain(name) -%}
    {#  Shows a Person name in plaintext. Shows firstname and a surname or patronyme. #}
    {{name.firstname}}
    {% if name.surname %}{{name.prefix}} {{name.surname}}{% else %}{{name.suffix}}{% endif %}
{%- endmacro %}

{% macro person_name_long(name) -%}
    {#  Formats a Person name. Shows all firstname, patronyme and surname. #}
    {{name.firstname}} <i>{{name.suffix}}</i> {{name.prefix}} <b>{{name.surname}}</b>
{%- endmacro %}

{# Now included in person_names_anon
{% macro person_names(person, names) -%}
{%- endmacro %}
#}

{% macro person_names_anon(person, names) -%}
    {#  Formats a Person name with link. Shows altername names also. #}
    {#  Anonymizes too new persons. #}
    {% if person.too_new %}
        N N
    {% else %}
        {# person_names(person, names) #}
	    {% for pn in names|sort(attribute='order') %}
	      {% if loop.first %}
	         {% if pn.type != "Birth Name" %}
	            <span class="typedesc">{{pn.type|transl('nt')}}</span>
	         {% endif %}
	         <a href="/person/{{person.iid}}" class="inlink"
	            title="{{ _('Person') }} {{ obj_title(person) }}">
	                {{ person_name_long(pn) }}</a>
	      {% else %}
	      <small><br> – 
	         {% if pn.type != "Birth Name" %}
	            <span class="typedesc">{{pn.type|transl('nt')}}</span>
	         {% endif %}
	        {{ person_name_long(pn) }}</small>
	      {% endif %}
	    {% endfor %}
     {% endif %}
{%- endmacro %}

{% macro person_name_by_sortname(p) -%}
    {#  Formats a Person name from person.sortname field. #}
    {% set nm = p.sortname.split('#') %}
    {{nm[2]}} <i>{{nm[1]}}</i> <b>{{nm[0]}}</b>
{%- endmacro %}

{% macro person_name_by_sortname_anon(p) -%}
    {#  Formats a Person name from person.sortname field. #}
    {% if p.too_new %}
        N N
    {% else %}
        <a href="/person/{{p.iid}}" class="inlink"
           title="{{ _('Person') }} {{ obj_title(p) }}">{{ person_name_by_sortname(p) }}</a>
     {% endif %}
{%- endmacro %}

{% macro person(p, iid="-") -%}
    {#  Creates a Person name and link using iid (for family tree graph). #}
    {% if p.iid == iid %}
    <span class="myself">({{ _('self') }})</span>
    {% else %}
    <a href="/person/{{p.iid}}" class="inlink"
       title="{{ _('Person') }} {{ obj_title(p) }}">
        {% if p.names|length > 0 %}{{ person_name(p.names[0]) }}</a>
	        {% if p.birth_date %}s.&nbsp;{{p.birth_date|pvm}}{% endif %}
	    {% else %}{{ _('Anonymous') }}</a>
        {% endif %}
    {% endif %}
{%- endmacro %}
                    
{% macro person_anon(p, iid="-") -%}
    {#  Creates a Person name and link using iid (for family tree graph). #}
    {% if p.too_new %}
	    N N
    {% else %}
	    {{ person(p, iid) }}
    {% endif %}
{%- endmacro %}

{% macro lifetimes(p) -%}
    {# Displays Person's life time estimates 'born 1662…1709 died 1726…1819' #}
    {% if p.death_high != 9999 %}
        {{ _('born') }} {% if p.birth_low != p.birth_high %}
            {{p.birth_low}}…{% endif 
        %}{{p.birth_high}} {{ _('died') }}  {{p.death_low}}{%
         if p.death_low != p.death_high 
         %}…{{p.death_high}}
         {% endif %}
    {% endif %}
{%- endmacro %}


# 2.2 Family

{% macro family_name(family) -%}
    {#  Formats a Family name with link. #}
         {# <span class="typedesc">{{family.rel_type|transl('marr')}}</span> #}
         <a href="/family/{{family.iid}}" class="inlink"
            title="{{ _('Family') }} {{ obj_title(family) }}">
            {% for name in [family.father_sortname, family.mother_sortname] %}
                {% set a = name.split('#') %}
                {{a[1]}} <i>{{a[2]}}</i> <b>{{a[0]}}</b>
                {% if not loop.last %}&amp;{% endif %}
            {%- endfor %}
            </a>
{%- endmacro %}


# 2.3 Note

{% macro notelink(note) -%}
    {#  Displays a Note text and link out #}
    {% if note.url %}
        <a href="{{note.url}}" class="outlink" 
           target="_blank">{{note.url|transl('urldomain')}}</a> –
    {% endif %}
    {% if note.text %}
	    {% set lines = note.text.split('\n') %}
	    {% for l in lines %}
	       {% if not loop.first %}<br>{% endif %}
	       <i>{{ l }}</i>
	    {% endfor %}
    {% endif %}
{%- endmacro %}

{# NOT USED {% macro notelink_2col(note) -%}
    {x  Displays a Note link and Note text in 2 columns x}
    <td>{% if note.url %}
    <a href="{{note.url}}" class="outlink" 
       target="_blank">{{note.url|transl('urldomain')}}</a>{% endif %}</td>
    {% set list1 = note.text.split('\n') %}
    <td>{% for l in list1 %}{{ l }} {% endfor %}</td>
{%- endmacro %}
#}

{% macro note_link(note_list, obj) -%}{#
       Creates template <sup>note link</sup> for each citation.
       - note_list  list of note uniq_ids
       - obj        dict of objects: obj[uniq_id] = Note object

#}{% if note_list %}<sup>{% for cr in note_list %}{%set note = obj[cr] %}
       <a id="N{{note.uniq_id}}"><b>{{note.type|transl('notet')}}</b> {{note.url}}
         <i>{{note.text}}</i></a>{% endfor %}</sup>{% endif 
%}{%- endmacro %}


# 2.3 Source, citation, reference

{% macro citation_link(cit_list, obj) -%}
    {# Creates template <sup>citation link</sup> for each citation.
       - cit_list   list of citation uniq_ids
       - obj        dict of objects: obj[uniq_id] = Citation object
     #}
    {% if cit_list %}<sup>{% for cr in cit_list %}
                    <a id="{{obj[cr].source_id}}-{{obj[cr].uniq_id}}">*</a>
    {% endfor %}</sup>{% endif %}
{%- endmacro %}

{% macro source_clip(clip_index, cita, source, repo_name, anchor_text, title) -%}
    {# 
        :param: clip_index  unique identifier (like runnin number)
        :param: cita        citation object
        :param: source      Source object
        :param: repo        Repository object
        :param: anchor_text link name like "Page"
        :param: title       optional title text
    #}

    {% if not title %}{% set title=_('Copy to clipboard') %}
    {% endif %}
    {% set ns = namespace(url="", page="") %}
    {% if cita.notes %}
        {% for note in cita.notes %}
            {% if note.url %}
                {% if "digi.narc.fi/" in note.url %}{% set ns.url = "; Kansallisarkisto: " + note.url %}
                {% else %}
                    {% if "sukuhistoria.fi/" in note.url 
                       or "digiarkisto.org/" in note.url %}{% set ns.url = "; SSHY: " + note.url %}
                    {% else %}{% set ns.url = "; URL: " + note.url %}
                    {% endif %}
                {% endif %}
                {% if note.text %}
                    {% set ns.url = ns.url + " " + note.text %}
                {% endif -%}
            {% endif %}
        {% endfor %}
    {% else %}
    	{% if cita.url and cita.url.startswith("http") %}
    		{# There is an url extracted from cita.page #}
    		{% set ns.url = "; URL: " + cita.url %}
    		{% if "hiski.genealogia.fi" in cita.url %}
	    		{% set p = cita.url.split("+t") %}
	    		{% if p %}{% set ns.page = ", sivu " + p[-1] %}{% endif %}
	    	{% else %}{% set ns.page = ", sivu " + cita.url %}
	    	{% endif %}
    	{% endif %}
    {% endif -%}
    {% if cita.page %}
        {% if 'sivu' in cita.page %}{% set ns.page = ", " + cita.page %}
        {% else %}{% set ns.page = ", sivu " + cita.page %}
        {% endif -%}
    {% endif -%}
    {% if repo_name %}
    	{% set txt = repo_name + " - " + source.stitle + ns.page + ns.url -%}
    {% else %}
    	{% set txt = "? - " + source.stitle + ns.page + ns.url -%}
    {% endif %}
        <input id="clp_id{{clip_index}}" type="text" style="display:None" value="{{txt}}">
        <div class="copy-fld" onclick="toClipboard('clp_id{{clip_index}}')"
              title="{{ title }}"> ⚓{{anchor_text}} </div>&nbsp;
{%- endmacro %}

{% macro source_citations(source_citations) %}
	{# Shows a div for Citations of Sources and Repositories
	   using data from Neo4jReadService.dr_get_sources_for_obj().
	   Calls macros source_clip, stars, notelink
	#}
	<style>
	   td.Citation {padding:.3em;}
	   td.Citation > div {display: inline }
	   td.Citation div ol {padding-top:.3em;}
	</style>
 
    <div class="subsection" id="citations">
        <h3>{{ _('Source References') }}</h3>
        <table class="infolist eventlist" width="100%">
            <tbody>
		{% for cite in source_citations %}
			{% set c = cite.citation %}
			{% set s = cite.source %}
			{% set r = cite.repository %}
	       		<tr>
	       		  <td class="Citation" style="text-align: center;">
	       		     <span title="sitaatti {{c.iid}} ({{c.id}})">{{loop.index}}.</span> 
	       		  </td>
	       		  <td class="Citation">
            {{ source_clip(loop.index, c, s, r.rname, s.stitle, _("Copy citation to clipboard")) }}

	        		<div title="{{c.confidence|transl('conf')}} {{ _('confidence') }}"
            			{% if c.confidence and c.confidence < "2" %}style="color:red"{% endif %}>
	   					<span><b>
	   			{% if c.url %}
	   						<a href="{{c.url}}" class="outlink" 
           					   target="_blank">{{c.url|transl('urldomain')}}</a>
	   			{% else %}  <a href="/source/{{s.iid}}" class="inlink"
	   						   title="{{ _('Source') }} {{s.id}} '{{s.iid}}'">{{c.page}}</a>
	   			{% endif -%}
	   					</b></span> {{ stars(c.confidence|float) }}
               		    	<ol type="a">
	               		{% for note in s.notes %}
                            	<li><span title="{{note.iid}} / {{note.id}}">–► </span>{{ notelink(note) }}
	                    {% endfor %}
	                      	</ol>
	                    </div>
	         		  </td>
	         		</tr>
		{% endfor %}
                </tbody></table>
	        </div>
{% endmacro %}

# 2.4 Place

{% macro place_names_lang(pl) -%}
    {# Displays Place_combo name variations as "Rymättylä / Rimito" #}
    {% for n in pl.names %}{% if not loop.first %} / {% endif %}
       {{ n.name|safe }}{% endfor 
%}{%- endmacro %}

{% macro place_names(pl) -%}
    {# Displays Place_combo name variations as "Rymättylä • SV Rimito" #}
    {% for n in pl.names %} {# pre-sorted, no |sort(attribute='lang') #}
        {% if not loop.first %} • {% endif %}
        {% if n.lang %}<span class='langcode'>{{n.lang}}</span>{% endif %}
        {{ n.name|safe }}
    {%- endfor %}
{%- endmacro %}


